{% extends 'custom_admin/base.html' %} {% block content %}

<!-- Summary Cards Grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
  <!-- Total Users Card -->
  <div
    class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition"
  >
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm text-gray-600 font-medium">Total Users</p>
        <p class="text-3xl font-bold text-gray-800 mt-2">{{ total_users }}</p>
        <p class="text-xs text-green-600 mt-2">
          <i class="ri-arrow-up-line"></i> +{{ new_users_week }} this week
        </p>
      </div>
      <div
        class="w-14 h-14 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center"
      >
        <i class="ri-shield-user-line text-4xl text-white"></i>
      </div>
    </div>
    <div
      class="mt-4 pt-4 border-t border-gray-100 flex justify-between text-xs text-gray-600"
    >
      <span
        ><i class="ri-user-3-line"></i> Villagers: {{ villagers_count }}</span
      >
      <span
        ><i class="ri-heart-pulse-line"></i> Workers:
        {{health_workers_count}}</span
      >
    </div>
  </div>

  <!-- Total Appointments Card -->
  <div
    class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition"
  >
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm text-gray-600 font-medium">Appointments</p>
        <p class="text-3xl font-bold text-gray-800 mt-2">
          {{ total_appointments }}
        </p>
        <p class="text-xs text-orange-600 mt-2">
          <i class="ri-calendar-line"></i> {{ today_appointments }} today
        </p>
      </div>
      <div
        class="w-14 h-14 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center"
      >
        <i class="ri-calendar-check-line text-2xl text-white"></i>
      </div>
    </div>
    <div
      class="mt-4 pt-4 border-t border-gray-100 flex justify-between text-xs text-gray-600"
    >
      <span class="text-yellow-600"
        ><i class="ri-time-line"></i> Pending: {{ pending_appointments }}</span
      >
      <span class="text-green-600"
        ><i class="ri-check-line"></i> Completed:
        {{completed_appointments}}</span
      >
    </div>
  </div>

  <!-- Total Chats Card -->
  <div
    class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition"
  >
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm text-gray-600 font-medium">Chat Sessions</p>
        <p class="text-3xl font-bold text-gray-800 mt-2">{{ total_chats }}</p>
        <p class="text-xs text-blue-600 mt-2">
          <i class="ri-message-line"></i> {{ chats_today }} today
        </p>
      </div>
      <div
        class="w-14 h-14 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center"
      >
        <i class="ri-chat-3-line text-2xl text-white"></i>
      </div>
    </div>
    <div
      class="mt-4 pt-4 border-t border-gray-100 flex justify-between text-xs text-gray-600"
    >
      <span
        ><i class="ri-user-star-line"></i> Active: {{ active_users_week }}</span
      >
      <span
        ><i class="ri-calendar-week-line"></i> This week:
        {{chats_this_week}}</span
      >
    </div>
  </div>

  <!-- Total Documents Card -->
  <div
    class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition"
  >
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm text-gray-600 font-medium">Documents</p>
        <p class="text-3xl font-bold text-gray-800 mt-2">
          {{ total_documents }}
        </p>
        <p class="text-xs text-indigo-600 mt-2">
          <i class="ri-file-add-line"></i> +{{ documents_this_month }} this
          month
        </p>
      </div>
      <div
        class="w-14 h-14 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-xl flex items-center justify-center"
      >
        <i class="ri-file-text-line text-2xl text-white"></i>
      </div>
    </div>
    <div
      class="mt-4 pt-4 border-t border-gray-100 flex justify-between text-xs text-gray-600"
    >
      <span><i class="ri-mail-line"></i> Enquiries: {{ total_enquiries }}</span>
      <span
        ><i class="ri-lightbulb-line"></i> Awareness: {{ total_awareness}}</span
      >
    </div>
  </div>
</div>

<!-- Charts and Statistics -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
  <!-- Appointments Trend Chart -->
  <div
    class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-200 p-6"
  >
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-lg font-bold text-gray-800">
        Appointments Trend (Last 7 Days)
      </h3>
      <div class="flex space-x-2">
        <span
          class="px-3 py-1 bg-purple-100 text-purple-700 text-xs font-medium rounded-full"
        >
          Weekly
        </span>
      </div>
    </div>
    <canvas id="appointmentChart" height="80"></canvas>
  </div>

  <!-- Appointment Status Breakdown -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <h3 class="text-lg font-bold text-gray-800 mb-6">Appointment Status</h3>
    <div class="space-y-4">
      <div>
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm font-medium text-gray-600">Pending</span>
          <span class="text-sm font-bold text-gray-800"
            >{{ pending_appointments }}</span
          >
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div
            class="bg-yellow-500 h-2 rounded-full"
            style="width: {% widthratio pending_appointments total_appointments 100 %}%"
          ></div>
        </div>
      </div>
      <div>
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm font-medium text-gray-600">Approved</span>
          <span class="text-sm font-bold text-gray-800"
            >{{ approved_appointments }}</span
          >
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div
            class="bg-blue-500 h-2 rounded-full"
            style="width: {% widthratio approved_appointments total_appointments 100 %}%"
          ></div>
        </div>
      </div>
      <div>
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm font-medium text-gray-600">Completed</span>
          <span class="text-sm font-bold text-gray-800"
            >{{ completed_appointments }}</span
          >
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div
            class="bg-green-500 h-2 rounded-full"
            style="width: {% widthratio completed_appointments total_appointments 100 %}%"
          ></div>
        </div>
      </div>
      <div>
        <div class="flex items-center justify-between mb-2">
          <span class="text-sm font-medium text-gray-600">Cancelled</span>
          <span class="text-sm font-bold text-gray-800"
            >{{ cancelled_appointments }}</span
          >
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div
            class="bg-red-500 h-2 rounded-full"
            style="width: {% widthratio cancelled_appointments total_appointments 100 %}%"
          ></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Recent Activity & Quick Actions -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
  <!-- Recent Appointments -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-lg font-bold text-gray-800">Recent Appointments</h3>
      <a
        href="{% url 'custom_admin:appointment_list' %}"
        class="text-sm text-purple-600 hover:text-purple-700 font-medium"
      >
        View all <i class="ri-arrow-right-line"></i>
      </a>
    </div>
    <div class="space-y-3">
      {% for appointment in recent_appointments %}
      <a
        href="{% url 'custom_admin:appointment_detail' appointment.id %}"
        class="block p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition"
      >
        <div class="flex items-center justify-between mb-2">
          <p class="text-sm font-semibold text-gray-800">
            {{appointment.villager.first_name}}{{appointment.villager.last_name}}
          </p>
          <span
            class="px-2 py-1 text-xs font-medium rounded-full {% if appointment.status == 'pending' %}bg-yellow-100 text-yellow-700 {% elif appointment.status == 'approved' %}bg-blue-100 text-blue-700 {% elif appointment.status == 'completed' %}bg-green-100 text-green-700 {% else %}bg-red-100 text-red-700{% endif %}"
          >
            {{ appointment.status|title }}
          </span>
        </div>
        <p class="text-xs text-gray-600">
          <i class="ri-calendar-line"></i> {{ appointment.date|date:"M d, Y" }}
          at {{ appointment.time|time:"g:i A" }}
        </p>
      </a>
      {% empty %}
      <div class="text-center py-8 text-gray-500">
        <i class="ri-calendar-line text-4xl mb-2"></i>
        <p class="text-sm">No appointments yet</p>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Recent Enquiries -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-lg font-bold text-gray-800">Recent Enquiries</h3>
      <a
        href="{% url 'custom_admin:enquiry_list' %}"
        class="text-sm text-purple-600 hover:text-purple-700 font-medium"
      >
        View all <i class="ri-arrow-right-line"></i>
      </a>
    </div>
    <div class="space-y-3">
      {% for enquiry in recent_enquiries %}
      <a
        href="{% url 'custom_admin:enquiry_detail' enquiry.id %}"
        class="block p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition"
      >
        <div class="flex items-center justify-between mb-2">
          <p class="text-sm font-semibold text-gray-800">
            {{ enquiry.first_name }} {{ enquiry.last_name }}
          </p>
          <span
            class="px-2 py-1 text-xs font-medium rounded-full {% if enquiry.status == 'pending' %}bg-yellow-100 text-yellow-700 {% elif enquiry.status == 'in_progress' %}bg-blue-100 text-blue-700 {% else %}bg-green-100 text-green-700{% endif %}"
          >
            {{ enquiry.status|title }}
          </span>
        </div>
        <p class="text-xs text-gray-600 truncate">
          {{ enquiry.message|truncatewords:10 }}
        </p>
      </a>
      {% empty %}
      <div class="text-center py-8 text-gray-500">
        <i class="ri-mail-line text-4xl mb-2"></i>
        <p class="text-sm">No enquiries yet</p>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Recent Documents -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-lg font-bold text-gray-800">Recent Documents</h3>
      <a
        href="{% url 'custom_admin:document_list' %}"
        class="text-sm text-purple-600 hover:text-purple-700 font-medium"
      >
        View all <i class="ri-arrow-right-line"></i>
      </a>
    </div>
    <div class="space-y-3">
      {% for document in recent_documents %}
      <a
        href="{% url 'custom_admin:document_detail' document.id %}"
        class="block p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition"
      >
        <div class="flex items-center space-x-3">
          <div
            class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center flex-shrink-0"
          >
            <i class="ri-file-text-line text-indigo-600 text-xl"></i>
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-semibold text-gray-800 truncate">
              {{ document.title }}
            </p>
            <p class="text-xs text-gray-600">
              By {{ document.uploaded_by.get_full_name }}
            </p>
          </div>
        </div>
      </a>
      {% empty %}
      <div class="text-center py-8 text-gray-500">
        <i class="ri-file-text-line text-4xl mb-2"></i>
        <p class="text-sm">No documents yet</p>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Chat & User Activity -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
  <!-- Chat Activity Chart -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <h3 class="text-lg font-bold text-gray-800 mb-6">
      Chat Activity (Last 7 Days)
    </h3>
    <canvas id="chatChart" height="100"></canvas>
  </div>

  <!-- Most Active Users -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <h3 class="text-lg font-bold text-gray-800 mb-6">
      Most Active Users (Chat)
    </h3>
    <div class="space-y-3">
      {% for user in most_active_users %}
      <div
        class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition"
      >
        <div class="flex items-center space-x-3">
          <div
            class="w-10 h-10 bg-gradient-to-br from-green-600 to-green-600 rounded-full flex items-center justify-center"
          >
            <span class="text-white font-semibold text-sm"
              >{{ user.user__first_name.0|default:'U'}}
            </span>
          </div>
          <div>
            <p class="text-sm font-semibold text-gray-800">
              {{ user.user__first_name }} {{ user.user__last_name }}
            </p>
            <p class="text-xs text-gray-500">
              @{{ user.user__username }} â€¢ {{ user.user__role|title }}
            </p>
          </div>
        </div>
        <div class="text-right">
          <p class="text-lg font-bold text-purple-600">{{ user.chat_count }}</p>
          <p class="text-xs text-gray-500">chats</p>
        </div>
      </div>
      {% empty %}
      <div class="text-center py-8 text-gray-500">
        <i class="ri-chat-off-line text-4xl mb-2"></i>
        <p>No chat activity yet</p>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Top Health Workers & Upcoming Events -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <!-- Top Health Workers -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <h3 class="text-lg font-bold text-gray-800 mb-6">Top Health Workers</h3>
    <div class="space-y-3">
      {% for worker in top_health_workers %}
      <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
        <div class="flex items-center space-x-3">
          <div
            class="w-10 h-10 bg-gradient-to-br from-green-500 to-green-600 rounded-full flex items-center justify-center"
          >
            <span class="text-white font-semibold text-sm"
              >{{ worker.healthworker__first_name.0}}
            </span>
          </div>
          <div>
            <p class="text-sm font-semibold text-gray-800">
              {{worker.healthworker__first_name}}{{worker.healthworker__last_name}}
            </p>
            <p class="text-xs text-gray-500">
              @{{ worker.healthworker__username }}
            </p>
          </div>
        </div>
        <div class="text-right">
          <p class="text-lg font-bold text-green-600">
            {{ worker.appointment_count }}
          </p>
          <p class="text-xs text-gray-500">appointments</p>
        </div>
      </div>
      {% empty %}
      <div class="text-center py-8 text-gray-500">
        <i class="ri-user-heart-line text-4xl mb-2"></i>
        <p class="text-sm">No data available</p>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Upcoming Events -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-lg font-bold text-gray-800">Upcoming Events</h3>
      <a
        href="{% url 'custom_admin:awareness_list' %}?type=event"
        class="text-sm text-purple-600 hover:text-purple-700 font-medium"
      >
        View all <i class="ri-arrow-right-line"></i>
      </a>
    </div>
    <div class="space-y-3">
      {% for event in upcoming_events %}
      <a
        href="{% url 'custom_admin:awareness_detail' event.id %}"
        class="block p-3 bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg hover:from-purple-100 hover:to-indigo-100 transition"
      >
        <div class="flex items-center space-x-3">
          <div
            class="w-12 h-12 bg-white rounded-lg flex flex-col items-center justify-center shadow-sm flex-shrink-0"
          >
            <span class="text-xs font-semibold text-gray-500"
              >{{ event.event_date|date:"M" }}</span
            >
            <span class="text-lg font-bold text-purple-600"
              >{{ event.event_date|date:"d" }}</span
            >
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-semibold text-gray-800 truncate">
              {{ event.title }}
            </p>
            <p class="text-xs text-gray-600">
              {{ event.event_date|date:"l, F d, Y" }}
            </p>
          </div>
          <i class="ri-calendar-event-line text-purple-600 text-xl"></i>
        </div>
      </a>
      {% empty %}
      <div class="text-center py-8 text-gray-500">
        <i class="ri-calendar-event-line text-4xl mb-2"></i>
        <p class="text-sm">No upcoming events</p>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

{% endblock %} {% block extra_scripts %}
<script>
  // Appointment Trend Chart
  const appointmentData = {{ appointment_trend|safe }};
  const appointmentLabels = appointmentData.map(item => item.date);
  const appointmentCounts = appointmentData.map(item => item.count);

  const appointmentCtx = document.getElementById('appointmentChart').getContext('2d');
  new Chart(appointmentCtx, {
      type: 'line',
      data: {
          labels: appointmentLabels,
          datasets: [{
              label: 'Appointments',
              data: appointmentCounts,
              borderColor: 'rgb(124, 58, 237)',
              backgroundColor: 'rgba(124, 58, 237, 0.1)',
              tension: 0.4,
              fill: true,
              pointBackgroundColor: 'rgb(124, 58, 237)',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointRadius: 5,
              pointHoverRadius: 7
          }]
      },
      options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
              legend: {
                  display: false
              }
          },
          scales: {
              y: {
                  beginAtZero: true,
                  ticks: {
                      precision: 0
                  }
              }
          }
      }
  });

  // Chat Activity Chart
  const chatData = {{ chat_trend|safe }};
  const chatLabels = chatData.map(item => item.date);
  const chatCounts = chatData.map(item => item.count);

  const chatCtx = document.getElementById('chatChart').getContext('2d');
  new Chart(chatCtx, {
      type: 'bar',
      data: {
          labels: chatLabels,
          datasets: [{
              label: 'Chat Sessions',
              data: chatCounts,
              backgroundColor: 'rgba(16, 185, 129, 0.8)',
              borderColor: 'rgb(16, 185, 129)',
              borderWidth: 2,
              borderRadius: 8
          }]
      },
      options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
              legend: {
                  display: false
              }
          },
          scales: {
              y: {
                  beginAtZero: true,
                  ticks: {
                      precision: 0
                  }
              }
          }
      }
  });
</script>
{% endblock %}
