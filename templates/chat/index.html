{% extends 'base.html' %}
{% load static %}
{% block title %}Rural Health Assistant{% endblock %}
{% block content %}

<div class="min-h-screen bg-gray-100 flex flex-col">
  
  <!-- Messages Container -->
  <div id="messages-container" class="flex-1 overflow-y-auto px-6 py-6">
    
    <!-- Welcome Message -->
    <div class="mb-8 flex justify-start">
      <div class="max-w-2xl">
        <div class="flex items-center space-x-2 mb-2">
          <div class="w-6 h-6 bg-blue-600 rounded-full flex items-center justify-center shrink-0">
            <span class="text-white text-xs font-semibold">AI</span>
          </div>
          <div class="text-xs font-medium text-gray-600">ASSISTANT</div>
        </div>
        <div class="bg-blue-50 border border-blue-200 rounded-lg px-5 py-4 shadow-sm">
          <p class="text-sm text-black">Hello {{ user.username }}, I'm here to assist you with health-related questions. How may I help you today?</p>
        </div>
      </div>
    </div>

    <!-- Chat History -->
    {% for chat in recent_chats reversed %}
    <!-- User Message -->
    <div class="mb-8 flex justify-end">
      <div class="max-w-2xl">
        <div class="flex items-center justify-end space-x-2 mb-2">
          <div class="w-6 h-6 bg-green-600 rounded-full flex items-center justify-center shrink-0">
            <span class="text-white text-xs font-semibold">{{ user.first_name|first|upper }}</span>
          </div>
          <div class="text-xs font-medium text-gray-600">{{ user.first_name|upper }}</div>
         
        </div>
        <div class="bg-green-50 border border-green-200 rounded-lg px-5 py-4 shadow-sm">
          <p class="text-sm text-black">{{ chat.question }}</p>
        </div>
      </div>
    </div>

    <!-- Assistant Message -->
    <div class="mb-8 flex justify-start">
      <div class="max-w-2xl">
        <div class="flex items-center space-x-2 mb-2">
          <div class="w-6 h-6 bg-blue-600 rounded-full flex items-center justify-center shrink-0">
            <span class="text-white text-xs font-semibold">AI</span>
          </div>
          <div class="text-xs font-medium text-gray-600">Health Assistant</div>
        </div>
        <div class="bg-blue-50 border border-blue-200 rounded-lg px-5 py-4 shadow-sm">
          <p class="text-sm text-black">{{ chat.answer }}</p>
        </div>
      </div>
    </div>
    {% endfor %}

    <!-- Typing Indicator -->
    <div id="typing-indicator" class="hidden mb-8 flex justify-start">
      <div class="max-w-2xl">
        <div class="flex items-center space-x-2 mb-2">
          <div class="w-6 h-6 bg-blue-600 rounded-full flex items-center justify-center shrink-0">
            <span class="text-white text-xs font-semibold">AI</span>
          </div>
          <div class="text-xs font-medium text-gray-600">Health Assistant</div>
        </div>
        <div class="bg-blue-50 border border-blue-200 rounded-lg px-5 py-4 shadow-sm">
          <div class="flex items-center space-x-1">
            <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div>
            <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div>
            <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Input Area -->
  <div class="bg-white border-t border-gray-300">
    <div class="px-6 py-4">
      <form id="chat-form">
        {% csrf_token %}
        <div class="flex items-center space-x-3">
          <input
            type="text"
            name="message"
            id="message-input"
            class="flex-1 px-4 py-3 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:border-gray-400 text-sm text-black placeholder-gray-500"
            placeholder="Type your message..."
            maxlength="500"
            autocomplete="off"
          />
          <button
            type="submit"
            id="send-btn"
            class="px-6 py-3 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Send
          </button>
        </div>
        <div class="flex items-center justify-between mt-2">
          <div class="flex space-x-2">
            <button type="button" class="quick-action" data-message="Find nearest hospital">Hospital</button>
            <button type="button" class="quick-action" data-message="Emergency contacts">Emergency</button>
            <button type="button" class="quick-action" data-message="Health tips">Tips</button>
            <button type="button" class="quick-action" data-message="Symptom checker">Symptoms</button>
          </div>
          <span id="char-counter" class="text-xs text-gray-500">0/500</span>
        </div>
      </form>
    </div>
  </div>

</div>

<style>
/* Quick action buttons */
.quick-action {
  padding: 0.375rem 0.75rem;
  font-size: 0.75rem;
  background-color: #f3f4f6;
  border: 1px solid #d1d5db;
  border-radius: 0.375rem;
  color: #374151;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s;
}

.quick-action:hover {
  background-color: #e5e7eb;
}

/* Scrollbar */
#messages-container::-webkit-scrollbar {
  width: 8px;
}

#messages-container::-webkit-scrollbar-track {
  background: #f3f4f6;
}

#messages-container::-webkit-scrollbar-thumb {
  background: #d1d5db;
  border-radius: 4px;
}

#messages-container::-webkit-scrollbar-thumb:hover {
  background: #9ca3af;
}

/* Animation */
.message-appear {
  animation: appear 0.2s ease-out;
}

@keyframes appear {
  from {
    opacity: 0;
    transform: translateY(8px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Full height layout */
html, body {
  height: 100%;
  margin: 0;
}

.min-h-screen {
  height: 100vh;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const chatForm = document.getElementById('chat-form');
  const messageInput = document.getElementById('message-input');
  const messagesContainer = document.getElementById('messages-container');
  const typingIndicator = document.getElementById('typing-indicator');
  const sendBtn = document.getElementById('send-btn');
  const charCounter = document.getElementById('char-counter');
  const quickActions = document.querySelectorAll('.quick-action');

  // Character counter
  messageInput.addEventListener('input', function() {
    const length = this.value.length;
    charCounter.textContent = `${length}/500`;
  });

  // Quick action buttons
  quickActions.forEach(btn => {
    btn.addEventListener('click', function() {
      messageInput.value = this.dataset.message;
      messageInput.focus();
    });
  });

  // Auto scroll to bottom
  function scrollToBottom() {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  // Show/hide typing indicator
  function showTyping() {
    typingIndicator.classList.remove('hidden');
    scrollToBottom();
  }

  function hideTyping() {
    typingIndicator.classList.add('hidden');
  }

  // Add message to chat
  function addMessage(message, isUser = false) {
    const messageHTML = isUser ? `
      <div class="mb-8 message-appear flex justify-end">
        <div class="max-w-2xl">
          <div class="flex items-center justify-end space-x-2 mb-2">
            <div class="text-xs font-medium text-gray-600">YOU</div>
            <div class="w-6 h-6 bg-green-600 rounded-full flex items-center justify-center shrink-0">
              <span class="text-white text-xs font-semibold">U</span>
            </div>
          </div>
          <div class="bg-green-50 border border-green-200 rounded-lg px-5 py-4 shadow-sm">
            <p class="text-sm text-black">${escapeHtml(message)}</p>
          </div>
        </div>
      </div>
    ` : `
      <div class="mb-8 message-appear flex justify-start">
        <div class="max-w-2xl">
          <div class="flex items-center space-x-2 mb-2">
            <div class="w-6 h-6 bg-blue-600 rounded-full flex items-center justify-center shrink-0">
              <span class="text-white text-xs font-semibold">AI</span>
            </div>
            <div class="text-xs font-medium text-gray-600">ASSISTANT</div>
          </div>
          <div class="bg-blue-50 border border-blue-200 rounded-lg px-5 py-4 shadow-sm">
            <p class="text-sm text-black">${message}</p>
          </div>
        </div>
      </div>
    `;

    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = messageHTML;
    messagesContainer.insertBefore(tempDiv.firstElementChild, typingIndicator);
    scrollToBottom();
  }

  // Escape HTML to prevent XSS
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Handle form submission
  chatForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const message = messageInput.value.trim();
    if (!message) return;

    // Add user message
    addMessage(message, true);
    
    // Clear input
    messageInput.value = '';
    charCounter.textContent = '0/500';
    
    // Show typing
    showTyping();
    sendBtn.disabled = true;

    // Send to server
    fetch("{% url 'chat:send_message' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
      },
      body: new URLSearchParams({ message: message }),
    })
    .then(response => response.json())
    .then(data => {
      hideTyping();
      sendBtn.disabled = false;
      
      if (data.success) {
        addMessage(data.answer, false);
      } else {
        addMessage('Sorry, I encountered an error. Please try again.', false);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      hideTyping();
      sendBtn.disabled = false;
      addMessage('Connection error. Please try again.', false);
    });
  });

  // Enter to send
  messageInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      chatForm.dispatchEvent(new Event('submit'));
    }
  });

  // Initial scroll
  setTimeout(scrollToBottom, 100);
});
</script>
{% endblock %}