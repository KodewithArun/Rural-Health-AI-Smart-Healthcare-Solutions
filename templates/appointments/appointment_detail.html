{% extends 'base.html' %}
{% load static %}

{% block title %}Appointment Details - {{ appointment.date|date:"M d, Y" }} | Rural Health AI{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-6 px-4 sm:px-6 lg:px-8">
    <div class="max-w-5xl mx-auto">
        <!-- Header with Back Button -->
        <div class="mb-6">
            <a href="{% url 'appointments:list' %}" 
               class="inline-flex items-center text-blue-600 hover:text-blue-700 text-sm mb-3">
                ‚Üê Back to Appointments
            </a>
            <h1 class="text-2xl font-semibold text-gray-900">Appointment Details</h1>
        </div>

        <!-- Status Banner -->
        <div class="mb-6">
            <div class="bg-white border border-gray-200 rounded-lg">
                <div class="p-5">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div>
                            <p class="text-xs text-gray-500 mb-2">Priority Level</p>
                            <span class="inline-flex items-center px-3 py-1.5 rounded-md text-sm font-bold border
                                {% if appointment.priority == 'critical' %}bg-red-50 text-red-700 border-red-300
                                {% elif appointment.priority == 'medium' %}bg-orange-50 text-orange-700 border-orange-300
                                {% else %}bg-green-50 text-green-700 border-green-300{% endif %}">
                                <i class="{% if appointment.priority == 'critical' %}ri-alert-fill{% elif appointment.priority == 'medium' %}ri-notification-3-fill{% else %}ri-check-line{% endif %} mr-2"></i>
                                {{ appointment.get_priority_display|upper }}
                            </span>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-2">Status</p>
                            <span class="inline-flex items-center px-3 py-1 rounded text-sm font-medium
                                {% if appointment.status == 'pending' %}bg-yellow-100 text-yellow-800
                                {% elif appointment.status == 'approved' %}bg-green-100 text-green-800
                                {% elif appointment.status == 'completed' %}bg-blue-100 text-blue-800
                                {% else %}bg-red-100 text-red-800{% endif %}">
                                {{ appointment.get_status_display }}
                            </span>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 mb-2">Appointment ID</p>
                            <p class="text-sm font-medium text-gray-900">#{{ appointment.pk }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column - Main Details -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Patient/Health Worker Information -->
                <div class="bg-white border border-gray-200 rounded-lg">
                    <div class="border-b border-gray-200 px-5 py-3">
                        <h2 class="text-base font-semibold text-gray-900">
                            {% if user.is_health_worker %}Patient Information{% else %}Health Worker Information{% endif %}
                        </h2>
                    </div>
                    <div class="p-5">
                        {% if user.is_health_worker or user.is_admin_role %}
                            <!-- Show patient info to health worker -->
                            <h3 class="text-lg font-medium text-gray-900 mb-4">
                                {{ appointment.villager.first_name }} {{ appointment.villager.last_name }}
                            </h3>
                            <div class="space-y-3">
                                <div>
                                    <p class="text-xs text-gray-500 mb-1">Email</p>
                                    <p class="text-sm text-gray-900">{{ appointment.villager.email }}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500 mb-1">Phone</p>
                                    <p class="text-sm text-gray-900">{{ appointment.villager.phone_number|default:"Not provided" }}</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500 mb-1">Username</p>
                                    <p class="text-sm text-gray-900">{{ appointment.villager.username }}</p>
                                </div>
                            </div>
                        {% else %}
                            <!-- Show health worker info to patient -->
                            <h3 class="text-lg font-medium text-gray-900 mb-4">
                                Dr. {{ appointment.healthworker.first_name }} {{ appointment.healthworker.last_name }}
                            </h3>
                            <div class="space-y-3">
                                {% if appointment.healthworker.health_profile %}
                                    <div>
                                        <p class="text-xs text-gray-500 mb-1">Specialization</p>
                                        <p class="text-sm text-gray-900">{{ appointment.healthworker.health_profile.specialization }}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-500 mb-1">Qualification</p>
                                        <p class="text-sm text-gray-900">{{ appointment.healthworker.health_profile.qualification|default:"Not specified" }}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-500 mb-1">Experience</p>
                                        <p class="text-sm text-gray-900">{{ appointment.healthworker.health_profile.experience_years }} years</p>
                                    </div>
                                {% endif %}
                                <div>
                                    <p class="text-xs text-gray-500 mb-1">Email</p>
                                    <p class="text-sm text-gray-900">{{ appointment.healthworker.email }}</p>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Appointment Reason -->
                <div class="bg-white border border-gray-200 rounded-lg">
                    <div class="border-b border-gray-200 px-5 py-3">
                        <h2 class="text-base font-semibold text-gray-900">Reason for Visit</h2>
                    </div>
                    <div class="p-5">
                        <div class="bg-gray-50 border border-gray-200 rounded p-4">
                            <p class="text-sm text-gray-900">{{ appointment.reason }}</p>
                        </div>
                    </div>
                </div>

                <!-- Health Worker Notes -->
                {% if appointment.note %}
                <div class="bg-white border border-gray-200 rounded-lg">
                    <div class="border-b border-gray-200 px-5 py-3">
                        <h2 class="text-base font-semibold text-gray-900">Health Worker Notes</h2>
                    </div>
                    <div class="p-5">
                        <div class="bg-blue-50 border border-blue-200 rounded p-4">
                            <p class="text-sm text-gray-900">{{ appointment.note }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Health Document -->
                {% if appointment.health_document %}
                <div class="bg-white border border-gray-200 rounded-lg">
                    <div class="border-b border-gray-200 px-5 py-3">
                        <h2 class="text-base font-semibold text-gray-900">
                            <i class="ri-file-text-line mr-1"></i> Health Document
                        </h2>
                    </div>
                    <div class="p-5">
                        <div class="bg-green-50 border border-green-200 rounded p-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    {% with doc_name=appointment.health_document.name %}
                                        {% if '.pdf' in doc_name %}
                                            <i class="ri-file-pdf-2-line text-2xl text-red-500"></i>
                                        {% elif '.jpg' in doc_name or '.jpeg' in doc_name or '.png' in doc_name %}
                                            <i class="ri-image-line text-2xl text-blue-500"></i>
                                        {% elif '.doc' in doc_name or '.docx' in doc_name %}
                                            <i class="ri-file-word-line text-2xl text-blue-600"></i>
                                        {% else %}
                                            <i class="ri-file-line text-2xl text-gray-500"></i>
                                        {% endif %}
                                    {% endwith %}
                                    <div>
                                        <p class="text-sm font-medium text-gray-900">
                                            {{ appointment.health_document.name|cut:"appointment_health_docs/" }}
                                        </p>
                                        <p class="text-xs text-gray-500">Uploaded by patient</p>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <a href="{{ appointment.health_document.url }}" target="_blank"
                                       class="inline-flex items-center px-3 py-1.5 text-sm font-medium text-blue-700 bg-blue-100 hover:bg-blue-200 rounded transition-colors">
                                        <i class="ri-eye-line mr-1"></i> View
                                    </a>
                                    <a href="{{ appointment.health_document.url }}" download
                                       class="inline-flex items-center px-3 py-1.5 text-sm font-medium text-green-700 bg-green-100 hover:bg-green-200 rounded transition-colors">
                                        <i class="ri-download-line mr-1"></i> Download
                                    </a>
                                </div>
                            </div>
                            {% with doc_name=appointment.health_document.name %}
                                {% if '.jpg' in doc_name or '.jpeg' in doc_name or '.png' in doc_name %}
                                    <div class="mt-3 border border-gray-200 rounded overflow-hidden">
                                        <img src="{{ appointment.health_document.url }}" alt="Health Document" 
                                             class="max-w-full max-h-64 object-contain mx-auto">
                                    </div>
                                {% endif %}
                            {% endwith %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Right Column - Date/Time & Actions -->
            <div class="space-y-6">
                <!-- Date & Time Card -->
                <div class="bg-white border border-gray-200 rounded-lg">
                    <div class="border-b border-gray-200 px-5 py-3">
                        <h2 class="text-base font-semibold text-gray-900">Schedule</h2>
                    </div>
                    <div class="p-5 space-y-4">
                        <div>
                            <p class="text-xs text-gray-500 mb-2">Date</p>
                            <p class="text-lg font-medium text-gray-900">{{ appointment.date|date:"F d, Y" }}</p>
                            <p class="text-xs text-gray-500 mt-1">{{ appointment.date|date:"l" }}</p>
                        </div>
                        <div class="pt-3 border-t border-gray-200">
                            <p class="text-xs text-gray-500 mb-2">Time</p>
                            <p class="text-lg font-medium text-gray-900">{{ appointment.time|time:"h:i A" }}</p>
                        </div>
                    </div>
                </div>

                <!-- Appointment Info -->
                <div class="bg-white border border-gray-200 rounded-lg">
                    <div class="border-b border-gray-200 px-5 py-3">
                        <h2 class="text-base font-semibold text-gray-900">Details</h2>
                    </div>
                    <div class="p-5 space-y-3">
                        <div class="flex justify-between py-2 border-b border-gray-100">
                            <span class="text-xs text-gray-500">Created</span>
                            <span class="text-sm text-gray-900">{{ appointment.created_at|date:"M d, Y" }}</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-gray-100">
                            <span class="text-xs text-gray-500">Time</span>
                            <span class="text-sm text-gray-900">{{ appointment.created_at|time:"h:i A" }}</span>
                        </div>
                        <div class="py-2">
                            <span class="text-xs text-gray-500 block mb-1">Token ID</span>
                            <span class="text-xs text-gray-900 font-mono break-all select-all">{{ appointment.token }}</span>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="bg-white border border-gray-200 rounded-lg">
                    <div class="border-b border-gray-200 px-5 py-3">
                        <h2 class="text-base font-semibold text-gray-900">Actions</h2>
                    </div>
                    <div class="p-5 space-y-3">
                        {% if user.is_health_worker or user.is_admin_role %}
                            <!-- Health Worker Actions -->
                            <a href="{% url 'appointments:update' appointment.pk %}" 
                               class="block text-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded">
                                Update Appointment
                            </a>
                            {% if user.is_admin_role %}
                            <form method="POST" action="{% url 'appointments:delete' appointment.pk %}" id="deleteAppointmentForm">
                                {% csrf_token %}
                                <button type="button" id="deleteAppointmentBtn"
                                        class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded">
                                    Delete Appointment
                                </button>
                            </form>
                            {% endif %}
                        {% else %}
                            <!-- Villager Actions -->
                            {% if can_cancel and appointment.status != 'cancelled' and appointment.status != 'completed' %}
                            <a href="{% url 'appointments:cancel' appointment.pk %}" 
                               class="block text-center px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded">
                                Cancel Appointment
                            </a>
                            {% else %}
                            <div class="bg-gray-50 border border-gray-200 rounded p-4 text-center">
                                <p class="text-xs text-gray-600">
                                    {% if appointment.status == 'cancelled' %}
                                        This appointment has been cancelled
                                    {% elif appointment.status == 'completed' %}
                                        This appointment has been completed
                                    {% else %}
                                        Cannot cancel (less than 24 hours)
                                    {% endif %}
                                </p>
                            </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Handle appointment deletion with modal
    const deleteBtn = document.getElementById('deleteAppointmentBtn');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', async function() {
            const confirmed = await modalAlert.confirm({
                title: 'Delete Appointment?',
                message: `
                    <div class="space-y-3 text-left">
                        <p>Are you sure you want to delete this appointment?</p>
                        <div class="bg-gray-50 border-l-4 border-red-500 p-3 rounded">
                            <p class="text-sm text-gray-700"><strong>Patient:</strong> {{ appointment.patient.get_full_name }}</p>
                            <p class="text-sm text-gray-700"><strong>Date:</strong> {{ appointment.date|date:"F d, Y" }}</p>
                            <p class="text-sm text-gray-700"><strong>Time:</strong> {{ appointment.time|time:"g:i A" }}</p>
                        </div>
                        <p class="text-red-600 font-semibold">This action cannot be undone.</p>
                    </div>
                `,
                icon: 'delete-bin',
                iconColor: 'red',
                confirmText: 'Delete',
                cancelText: 'Cancel'
            });

            if (confirmed) {
                document.getElementById('deleteAppointmentForm').submit();
            }
        });
    }
</script>
{% endblock %}