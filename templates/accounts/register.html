{% extends 'base.html' %}
{% block content %}
<div class="min-h-screen bg-gray-50 flex flex-col justify-center py-12 sm:px-6 lg:px-8">
  <div class="sm:mx-auto sm:w-full sm:max-w-md">
    <!-- Logo and Header -->
    <div class="text-center">

      <h1 class="text-2xl font-bold text-blue-600 tracking-tight">
        Create Your Account
      </h1>
      <p class="mt-2 text-sm text-gray-600">Join our healthcare community</p>
    </div>
  </div>

  <div class="mt-8 sm:mx-auto sm:w-full sm:max-w-2xl">
    <div class="bg-white py-8 px-6 shadow-sm rounded-lg border border-gray-200">
      
      <!-- Messages Display -->
      {% if messages %}
        {% for message in messages %}
          <div class="mb-4 p-4 rounded-md {% if message.tags == 'error' %}bg-red-50 border border-red-200{% else %}bg-green-50 border border-green-200{% endif %}">
            <div class="flex">
              <div class="flex-shrink-0">
                {% if message.tags == 'error' %}
                  <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                  </svg>
                {% else %}
                  <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                  </svg>
                {% endif %}
              </div>
              <div class="ml-3">
                <p class="text-sm font-medium {% if message.tags == 'error' %}text-red-800{% else %}text-green-800{% endif %}">
                  {{ message }}
                </p>
              </div>
            </div>
          </div>
        {% endfor %}
      {% endif %}

      <!-- Form Errors -->
      {% if form.errors %}
        <div class="mb-4 p-4 rounded-md bg-red-50 border border-red-200">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="ml-3">
              <h3 class="text-sm font-medium text-red-800">Please correct the following errors:</h3>
              <ul class="mt-2 text-sm text-red-700 list-disc list-inside">
                {% for field, errors in form.errors.items %}
                  {% for error in errors %}
                    <li>{{ error }}</li>
                  {% endfor %}
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
      {% endif %}

      <!-- Registration Form -->
      <form id="registrationForm" class="space-y-6" method="POST" novalidate>
        {% csrf_token %}
        
        <!-- Hidden role field -->
        <input type="hidden" name="role" value="villager" />
        
        <!-- Username Field -->
        <div>
          <label for="id_username" class="block text-sm font-medium text-gray-700 mb-1">
            Username <span class="text-red-500">*</span>
          </label>
          <input
            id="id_username"
            name="username"
            type="text"
            required
            minlength="3"
            maxlength="150"
            pattern="^[a-zA-Z0-9_]+$"
            value="{{ form.username.value|default:'' }}"
            class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 {% if form.username.errors %}border-red-300 focus:border-red-500 focus:ring-red-500{% endif %}"
            placeholder="Enter username (letters, numbers, underscore only)"
            aria-describedby="username-help"
          />
          <div id="username-help" class="mt-1 text-xs text-gray-500">
            3-150 characters. Letters, numbers and underscores only.
          </div>
          <div id="username-error" class="mt-1 text-sm text-red-600 hidden"></div>
        </div>

        <!-- Email Field -->
        <div>
          <label for="id_email" class="block text-sm font-medium text-gray-700 mb-1">
            Email Address <span class="text-red-500">*</span>
          </label>
          <input
            id="id_email"
            name="email"
            type="email"
            required
            maxlength="254"
            value="{{ form.email.value|default:'' }}"
            class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 {% if form.email.errors %}border-red-300 focus:border-red-500 focus:ring-red-500{% endif %}"
            placeholder="Enter your email address"
            aria-describedby="email-help"
          />
          <div id="email-help" class="mt-1 text-xs text-gray-500">
            We'll send account verification to this email.
          </div>
          <div id="email-error" class="mt-1 text-sm text-red-600 hidden"></div>
        </div>

        <!-- Password Field -->
        <div>
          <label for="id_password1" class="block text-sm font-medium text-gray-700 mb-1">
            Password <span class="text-red-500">*</span>
          </label>
          <div class="relative">
            <input
              id="id_password1"
              name="password1"
              type="password"
              required
              minlength="8"
              class="block w-full px-3 py-2 pr-10 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 {% if form.password1.errors %}border-red-300 focus:border-red-500 focus:ring-red-500{% endif %}"
              placeholder="Create a strong password"
              aria-describedby="password-help"
            />
            <button
              type="button"
              id="togglePassword1"
              class="absolute inset-y-0 right-0 pr-3 flex items-center"
              aria-label="Toggle password visibility"
            >
              <svg id="eyeIcon1" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
              </svg>
            </button>
          </div>
          <div id="password-help" class="mt-1 text-xs text-gray-500">
            Minimum 8 characters with letters, numbers and special characters.
          </div>
          <div id="password-strength" class="mt-2">
            <div class="flex space-x-1">
              <div class="h-1 w-1/4 bg-gray-200 rounded" id="strength-1"></div>
              <div class="h-1 w-1/4 bg-gray-200 rounded" id="strength-2"></div>
              <div class="h-1 w-1/4 bg-gray-200 rounded" id="strength-3"></div>
              <div class="h-1 w-1/4 bg-gray-200 rounded" id="strength-4"></div>
            </div>
            <p id="strength-text" class="text-xs text-gray-500 mt-1">Password strength</p>
          </div>
          <div id="password1-error" class="mt-1 text-sm text-red-600 hidden"></div>
        </div>

        <!-- Confirm Password Field -->
        <div>
          <label for="id_password2" class="block text-sm font-medium text-gray-700 mb-1">
            Confirm Password <span class="text-red-500">*</span>
          </label>
          <div class="relative">
            <input
              id="id_password2"
              name="password2"
              type="password"
              required
              class="block w-full px-3 py-2 pr-10 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 {% if form.password2.errors %}border-red-300 focus:border-red-500 focus:ring-red-500{% endif %}"
              placeholder="Confirm your password"
              aria-describedby="password2-help"
            />
            <button
              type="button"
              id="togglePassword2"
              class="absolute inset-y-0 right-0 pr-3 flex items-center"
              aria-label="Toggle password visibility"
            >
              <svg id="eyeIcon2" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
              </svg>
            </button>
          </div>
          <div id="password2-help" class="mt-1 text-xs text-gray-500">
            Must match the password above.
          </div>
          <div id="password2-error" class="mt-1 text-sm text-red-600 hidden"></div>
        </div>

        <!-- Terms and Privacy -->
        <div class="flex items-start">
          <input
            id="terms"
            name="terms"
            type="checkbox"
            required
            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded mt-0.5"
          />
          <label for="terms" class="ml-2 block text-sm text-gray-700">
            I agree to the <a href="#" class="text-blue-600 hover:text-blue-500 underline">Terms of Service</a> 
            and <a href="#" class="text-blue-600 hover:text-blue-500 underline">Privacy Policy</a> 
            <span class="text-red-500">*</span>
          </label>
        </div>

        <!-- Submit Button -->
        <div>
          <button
            type="submit"
            id="submitBtn"
            class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed transition duration-200"
          >
            <span id="submit-text">Create Account</span>
            <svg id="submit-spinner" class="animate-spin -mr-1 ml-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </button>
        </div>
      </form>

      <!-- Sign In Link -->
      <div class="mt-6 text-center">
        <p class="text-sm text-gray-600">
          Already have an account?
          <a href="{% url 'accounts:login' %}" class="font-medium text-blue-600 hover:text-blue-500 transition duration-200">
            Sign in here
          </a>
        </p>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('registrationForm');
  const submitBtn = document.getElementById('submitBtn');
  const submitText = document.getElementById('submit-text');
  const submitSpinner = document.getElementById('submit-spinner');
  
  // Password visibility toggles
  const toggles = [
    { btn: 'togglePassword1', input: 'id_password1', icon: 'eyeIcon1' },
    { btn: 'togglePassword2', input: 'id_password2', icon: 'eyeIcon2' }
  ];
  
  toggles.forEach(toggle => {
    document.getElementById(toggle.btn).addEventListener('click', function() {
      const input = document.getElementById(toggle.input);
      const icon = document.getElementById(toggle.icon);
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L8.464 8.464m1.414 1.414L12 12m0 0l2.122 2.122M12 12L9.878 9.878"/>';
      } else {
        input.type = 'password';
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>';
      }
    });
  });
  
  // Real-time validation
  const fields = {
    username: {
      element: document.getElementById('id_username'),
      error: document.getElementById('username-error'),
      validate: function(value) {
        if (!value) return 'Username is required.';
        if (value.length < 3) return 'Username must be at least 3 characters.';
        if (value.length > 150) return 'Username must be less than 150 characters.';
        if (!/^[a-zA-Z0-9_]+$/.test(value)) return 'Username can only contain letters, numbers, and underscores.';
        return null;
      }
    },
    email: {
      element: document.getElementById('id_email'),
      error: document.getElementById('email-error'),
      validate: function(value) {
        if (!value) return 'Email is required.';
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) return 'Please enter a valid email address.';
        return null;
      }
    },
    password1: {
      element: document.getElementById('id_password1'),
      error: document.getElementById('password1-error'),
      validate: function(value) {
        if (!value) return 'Password is required.';
        if (value.length < 8) return 'Password must be at least 8 characters.';
        return null;
      }
    },
    password2: {
      element: document.getElementById('id_password2'),
      error: document.getElementById('password2-error'),
      validate: function(value) {
        const password1 = fields.password1.element.value;
        if (!value) return 'Please confirm your password.';
        if (value !== password1) return 'Passwords do not match.';
        return null;
      }
    }
  };
  
  // Password strength indicator
  function updatePasswordStrength(password) {
    const indicators = ['strength-1', 'strength-2', 'strength-3', 'strength-4'];
    const strengthText = document.getElementById('strength-text');
    
    let strength = 0;
    if (password.length >= 8) strength++;
    if (/[a-z]/.test(password)) strength++;
    if (/[A-Z]/.test(password)) strength++;
    if (/[0-9]/.test(password)) strength++;
    if (/[^A-Za-z0-9]/.test(password)) strength++;
    
    indicators.forEach((id, index) => {
      const element = document.getElementById(id);
      if (index < strength) {
        if (strength <= 2) element.className = 'h-1 w-1/4 bg-red-500 rounded';
        else if (strength <= 3) element.className = 'h-1 w-1/4 bg-yellow-500 rounded';
        else element.className = 'h-1 w-1/4 bg-green-500 rounded';
      } else {
        element.className = 'h-1 w-1/4 bg-gray-200 rounded';
      }
    });
    
    const strengthLabels = ['Weak', 'Weak', 'Fair', 'Good', 'Strong'];
    strengthText.textContent = password ? `Password strength: ${strengthLabels[Math.max(0, strength - 1)]}` : 'Password strength';
  }
  
  // Add real-time validation listeners
  Object.keys(fields).forEach(key => {
    const field = fields[key];
    field.element.addEventListener('input', function() {
      const error = field.validate(this.value);
      
      if (error) {
        field.error.textContent = error;
        field.error.classList.remove('hidden');
        field.element.classList.add('border-red-300', 'focus:border-red-500', 'focus:ring-red-500');
        field.element.classList.remove('border-gray-300', 'focus:border-blue-500', 'focus:ring-blue-500');
      } else {
        field.error.classList.add('hidden');
        field.element.classList.remove('border-red-300', 'focus:border-red-500', 'focus:ring-red-500');
        field.element.classList.add('border-gray-300', 'focus:border-blue-500', 'focus:ring-blue-500');
      }
      
      if (key === 'password1') {
        updatePasswordStrength(this.value);
        // Also revalidate password2 if it has a value
        if (fields.password2.element.value) {
          const password2Error = fields.password2.validate(fields.password2.element.value);
          if (password2Error) {
            fields.password2.error.textContent = password2Error;
            fields.password2.error.classList.remove('hidden');
          } else {
            fields.password2.error.classList.add('hidden');
          }
        }
      }
    });
    
    field.element.addEventListener('blur', function() {
      const error = field.validate(this.value);
      if (error) {
        field.error.textContent = error;
        field.error.classList.remove('hidden');
      }
    });
  });
  
  // Form submission
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validate all fields
    let hasErrors = false;
    Object.keys(fields).forEach(key => {
      const field = fields[key];
      const error = field.validate(field.element.value);
      if (error) {
        field.error.textContent = error;
        field.error.classList.remove('hidden');
        hasErrors = true;
      }
    });
    
    // Check terms checkbox
    const termsCheckbox = document.getElementById('terms');
    if (!termsCheckbox.checked) {
      alert('Please accept the Terms of Service and Privacy Policy.');
      hasErrors = true;
    }
    
    if (!hasErrors) {
      // Show loading state
      submitBtn.disabled = true;
      submitText.textContent = 'Creating Account...';
      submitSpinner.classList.remove('hidden');
      
      // Submit form
      form.submit();
    }
  });
});
</script>
{% endblock %}